1      以外网速率和双工模式：   
1.1      速率模式：   
速率模式有：10M，100M，1000M，……

1.2      双工模式：   
半双工模式（half-duplex）：每个端点都可以发送和接收，但不能同时发送和接收。当其中一个端点在发送时，则另一个只能接收，反之亦然。在半双工模式下，无论那一方开始传输，就使用信道的整个带宽。半双工会出现冲突。

全双工模式（full-duplex）：两个端点可以同时进行发送和接收。在全双工模式下，两个方向的信息共享链路带宽，这种共享可以以两种方式进行：要么链路具有两条物理上独立的传输路径，一条发送一条接收；要么同时传输两个方向的信号将信道的带宽一分为二。全双工不会出现冲突。

1.3      网口工作模式：   
网口工作模式：10M半双工、10M全双工、100M半双工、100M全双工，1000M全双工，10/100M/1000M自协商，……

2      以太网速率双工自协商原理   
最早的以太网都是10M半双工的。所以需要“载波侦听、冲突回退”等一系列机制保证系统的稳定性。以太网即插即用的方便以及便宜的价格使得其成为最主流的局域网应用。随着技术的发展，出现了全双工，接着又出现了100M，以太网的性能大大改善。但是随之而来的问题是：如何保证原有以太网络和新出现的兼容？

以太网接口自协商规范应运而生。这样如果两边都是自协商，就可以工作在100M全双工，如果对端是10M半双工，那么协商不成功，会变成10M半双工，正好也对上了。以太网速率双工自协商在如下标准中定义：

l  快速以太网标准IEEE 802.3u第28节

l  千兆以太网标准IEEE 802.3z第37节

其中，IEEE 802.3u规范将自协商作为可选功能。802.3z规范将自协商作为强制功能，所有设备必须遵循并且必须默认启用自协商。

自动协商模式是端口根据另一端设备的连接速度和双工模式，自动把它的速度调节到最高的公共水平，即线路两端能具有的最快速度和双工模式。以太网速率双工链路自协商正常协商优先级别从高到低进行，顺序如下：

l  千兆全双工

l  千兆半双工

l  百兆全双工

l  百兆半双工

l  十兆全双工

l  十兆半双工

自协商功能允许一个网络设备能够将自己所支持的工作模式信息传达给网络上的对端，并接受对方可能传递过来的相应信息，从而解决双工和10M/100M速率自协商问题。自协商功能完全由物理层芯片设计实现，因此并不使用专用数据包或带来任何高层协议开销。

自协商功能的基本机制是：每个网络设备在上电、管理命令发出、或是用户干预时发出FLP（快速连接脉冲），协商信息封装在这些FLP序列中。FLP中包含有时钟/数字序列，将这些数据从中提取出来就可以得到对端设备支持的工作模式，以及一些用于协商握手机制的其他信息。当一个设备不能对FLP作出有效反应，而仅返回一个NLP（普通连接脉冲）时，它被作为一个10BASE-T兼容设备。快速链路脉冲FLP和普通链路脉冲NLP都仅使用于非屏蔽双绞线上，而不能应用在光纤媒体。1000BASE-X的自协商功能是将信息包含在/C/命令集中，该命令集类似于FLP脉冲。

3      更进一步：   
3.1      如果一个端口设置为100M/全双工，另一个端口设置为自协商，那么，自协商的结果会是100M/全双工吗？   
通过实践，我们知道，自协商的结果是100M/半双工，这种一端为强制性配置，一端为自协商配置的组网情况在网络中只有小流量的数据时，是没有问题的。因为只要流量可以被100M/半双工处理过来，网络上就不会有错误的数据包出现。但是，如果数据量超过了100M/半双工的处理能力，这种配置就会导致网络上出现大量的错误报文，影响网络的使用性能。所以，我们一般对互连端口的配置都配置为相同的速率和工作模式。如果一个端口是强制的10M或者100M带宽，另一个端口也设置为相同的强制带宽；同理，双工的工作模式也设置为相同的工作模式。如果一个端口被配置为了自协商，另一个端口也应该被配置为自协商。这就是我们所说的端口速率/双工模式的一致性。

通过端口一致性的配置原则，我们就解决了因端口的配置问题导致的网络性能下降问题。但是，为什么会产生这样的问题呢？

3.2      为什么我们在将一个端口配置为100M带宽，另一个端口配置为10M带宽，结果10M带宽的端口可以上报UP，但是100M端口却是DOWN的状态呢？   
端口间的自协商是依靠FLP（FAST LINK PULSE）或者NLP（NORMAL LINK PULSE）来实现的。FLP是一种间隔8-24ms的脉冲序列，即每组FLP之间的间隔是8-24ms。每一组FLP由时钟脉冲和数据脉冲组成，共有33个。其中时钟脉冲17个，数据脉冲16个。时钟脉冲的间隔是111-139us，数据脉冲和时钟脉冲的间隔是55.5-69.5us。时钟脉冲/数据脉冲的平均间隔是125us，也就是我们常讲的125M线路脉冲。但是，作为NLP，它仅仅是一个间隔为16ms的脉冲元。也就是说，如果FLP和NLP同时发送的话，每组FLP的第一个脉冲和NLP的脉冲元是可以相互重合的。如果我们通过检测连续的脉冲元来判断链路的状态的话，FLP会对检测NLP的端口造成一种欺骗，结果就是使得该端口误以为链路是好的，从而端口会上报UP。实际上10M端口正是通过NLP的检测，来解决链路的UP状态的上报的。关于FLP和NLP的脉冲发送形式如下所示：
3.3      如果一端配置为强制的100M/全双工或者10M/全双工，另一端配置为自协商，为什么这个端口只能协商到相同的带宽，可是双工模式为什么只能协商为半双工呢？   
如果将一个端口设置为100M/全双工，另一个端口设置为自协商，自协商的端口为什么学习不到双工的信息呢？这是由FLP中的数据脉冲序列携带的信息决定的。
前面我们讲到了FLP中存在两种脉冲信号，时钟脉冲信号和数据脉冲信号。如果我们将数据脉冲捡出来，组成一个16比特的序列的话，那么这个序列携带的信息就是自协商所需要的了，我们又将其称为LCW（LINK CODE WORD）链接码字。序列的格式如下：
其实，我们在设备上通过命令字对端口进行某种操作，就是将相应的MII寄存器的比特位置0或置1，来使能端口的某些功能。PHY芯片内部再通过仲裁机制来决定使能相应的PMA。当通过仲裁机制来选择端口间的最大利用率模式时，只有对应的半双工模式的PMA可以被自动检测到，全双工模式的PMA是要强制才可以使能的。这就是为什么当我们对两个互连的端口分别设置为100M/全双工和自协商时，自协商的端口只能协商到相同的带宽，但是却总是半双工模式了。
