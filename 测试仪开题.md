# 基于ONU芯片的网络测试仪的设计和实现
## 研究目的和意义
目前，国内对于接入网芯片设备的可靠性测试手段主要包括两种，其中一种
主要针对高端产品线，通过引进国外高成本测试仪表对产品进行全面测试，确保网络产
品的质量与性能，但会导致网络产品成本上升，甚至对网络产品的安全性和保密性造成
严重威胁；另一种主要针对普通产品线，通过电脑或手机软件进行简单的可靠性测试，
从而达到节约网络成本的目的，但无法保证产品的质量和性能。因此，开发一款用于测
试接入网芯片等设备，并兼具低成本、高性能特点的网络测试仪表有着很高的应用
前景
在上述研究背景下，本文提出了一种基于现场可编程门阵列的网络报文解析和性能测试单元的设计实现方案，这种方案是基于
上位机软件+Power PC+FPGA 的网络测试仪系统构架实现的，同时支持千兆以太网接口和光纤接口两种测试方式。本设计方案不仅支持 RFC2544、RFC2889、RFC3918 等国际协议标准的测试协议，同时还支持环网自愈等定制化的测试需求。用户可以根据上位机控制软件选择测试协议和测试模式，FPGA 芯片可以根据控制命令实现不同的测试协议。
'''本文研究的网络报文解析和性能测试单元的设计实现方案，在网络测试仪的系统中对于
测试协议的实现有着至关重要的作用，对于我国在网络测试仪表领域上的研究具有一定
的应用和参考价值，进一步推动了网络测试仪产品的国产化。 '''

## 国内外网络测试仪的发展和现状
因为网络在国外已经非常普及，所以国外网络测试方面的产品增长的也非常快。除了一些知名的仪表制造厂家推出系列化的仪表外，很多其它公司也加入这一领域。他们的数据通信仪表不仅类型齐全，而且功能强大。网络测试仪这一通用概念刚出现，就因其巨大的市场应用价值得到了迅速发展。目前，国际市场上较为主流的网络测试仪大多来自英国思博伦通信公司（Spirent），产品可以覆盖云基础设施、高速率网络、网络安全以及无线通信等多个业务范畴
还有如CTC的 HCT6000，FLUKE的One Touch、FLUKE68X等以及HP、WG、T1℃等老牌仪表商的优秀产品。它们占据了测试仪器市场的主要部分。国外测试仪器一般硬件水平高，采用专用集成电路芯片，减少硬件复杂程度和体积，并增加了可靠性， 有的公司采用TDSP芯片作处理器，可以完成复杂数据的处理，仪器功能多，可适应多种传输测试的需要。在国内最常用的几款测试仪表据来自于欧美国家。目前，市场上比较流行的是安捷伦公司生产的FrameScopePro千兆以太网测试仪，RFC2544性能测试仪，

  - 国外测试仪：
  安捷伦、思博伦、IXIA（？）
  测试接口多 测试性功能够
  - 国内测试仪：
国内对于网络测试仪的研究起步较晚，发展较慢。国内已知的比较完善的网络测试仪产品以北京信而泰公司生产的测试仪为代表，信而泰公司于 2007 年在北京成立，从简单的流量测试业务到如今的简单网络测试，产品主要包括网络仿真与性能测试、网络监测与运行维护两类，可以对通信终端、交换机与路由器、网络监测等网络设备的性能进行测试。
但是国内的这款仪表从性能上来说都无法与前面两款相比较，在处理大规模数据时，缺乏稳定性与可靠性，长远看来，无法满足市场对网络测试仪功能日益增长的需求。目前国内测试仪表存在以下问题：
	商用仪表涉A，商业使用受到极大限制
	测试仪表的需求量多，使用成本高
	自研Tesgine3.0不支持GE接口，Tesgine2.0面临停产
	现有主用测试仪表不能满足如以太接口的半双工功能、帧抢占、超短帧等测试需求

比较国内外网络测试仪产品可知，国外成熟的网络测试仪产品在功能方面比较全面，
除了测试交换机和路由器等网设备必须使用的测试功能外，通常会附加很多不常用的功
能，导致价格较高，国内大部分的中小厂商难以承受；另外，国外的网络测试仪无法对
设备的保密性和安全性进行保证，具有一定的安全隐患。国内的网络测试仪可以为网络
设备的大部分测试需求提供支持，但是功能不完善，在性能测试的一些指标和附加功能
上还有待改进提高。所以，研发一款高可靠性、高性价比、可定制化以及功能明确简洁
的网络测试仪可以在一定程度上推动国内对于网络测试仪产品的研究，减小中小型交换
机、路由器开发厂商的压力。 

  Tesgine  信而泰
  
## 整体架构
本文基于“上位机软件+CLI命令行接口+ont芯片”的构架对网络测试仪系统进行设计。其
中，上位机软件提供人机交互，实现用户配置、控制和测试结果显示的功能；
ont芯片可以实现网络报文构造、发送和网络报文接收、解析、性能测试等功能；
CLI命令行接口作为上位机控制软件和芯片之间的通信桥梁，可以实现解析、发送、缓冲的功能；
1.  网络测试仪系统的工作原理：
（1） 上位机控制软件主要实现人机交互功能，为用户提供参数配置接口，配置参数
包括端口属性、端口收发模式、传输速率、报文长度、测试协议、测试时间和
报文过滤器等。 
（2） CLI作为上位机控制软件和ont芯片之间的通信桥梁，完成命令解析、信息
转发、数据缓冲和部分协议处理的功能。 
（3） ont芯片是网络测试仪系统的核心，实现了网络报文的构造发送、接收解析、性
能测试以及以太网接口功能，并且完成报文统计、命令解析和信息上送等工作。

2.  网络测试仪系统的关键技术：
（1） 上位机控制软件采用插件式的管理构架，可以支持性能测试软件包的独立安装
和升级，具有很好的扩展性。 
（2） 上位机控制软件和网络测试仪之间的通信协议需要具有多样性、灵活性和简洁
性的特点，可以实现测试中各种控制命令和交互信息的传输。 

## 测试仪实现需求
发送方向：报文构造，流量控制
接收方向：报文校验，流量监控
## PIE模块工作原理
1、从业务接口（ETH、PON、…）接收到需要捕获送交CPU的报文时，在转发模块 （微码、硬转发）模块会在报文前添加LRO_INFO和PKT_INFO信息。其中PKT_INFO和PKT_INFO的格式因芯片不同会存在差异。
2、PIE逻辑从转发模块接收到报文时将报文透传给CPU。
3、CPU可以采用中断方式或轮循方式接收报文。
3.1.2	发送方向
1、软件在发送报文时需要：1）将PKTINFO信息写到描述符中；2）将待发送的报文内容写到描述符缓存区中。单次发包时每发送一个报文需要写一次描述符和报文内容，周期发包时只需要在初始化的时候写一次描述符和报文内容即可。
2、PIE逻辑从描述符和描述符缓存区中取出待发送的报文内容，并在待发送的报文前添加PKT_CTRL和PKT_INFO信息，之后将报文向转发模块发送。
3、转发模块在接收到报文时删除PKT_CTRL和PKT_INFO之后将报文向业务接口转发。

