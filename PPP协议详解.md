2. ppp协议
2.1 概述	
PPP是为在同等单元之间传输数据包这样的简单的链路而设计的。这种链路提供全双工操作，并按照顺序传递数据包。（人们）有意让PPP为基于各种主机、网桥和路由器的简单连接提供一种共通的解决方案。
	PPP协议主要包括三部分：LCP（Link Control Protocol）链路控制协议、NCP（Network Control Protocol）报文控制协议，和PPP的扩展协议（如Multilink Protocol）。随着网络技术的不断发展，网络带宽已不在是瓶颈，所以PPP扩展协议的应用也就越来越少，AI路由器拨号时也没有用，这里就不加以论述。PPP协议默认是不进行认证配置参数选项的协商，它只作为一个可选的参数，当点对点线路的两端需要进行认证时才需配置。当然在实际应用中这个过程是不可忽略的，例如我们使用计算机上网时，需要通过PPP协议与NAS设备互连，在整个协议的协商过程中，我们需要输入用户名和密码。
AI路由器PPP协议主要论述三个部分：LCP（Link Control Protocol）链路控制协议、CHAP（Challenge Handshake Authentication Protocol）挑战握手认证协议、IPCP(IP 报文控制协议)。

 从上图可以看到ppp会话建立是通过LCP、CHAP和IPCP这几步建立起来的。

2.2 ppp协议的组件
	PPP 有三个主要的组成部分：
    1. 在串行链路上封装数据报（datagrams）的方法。
	2. 建立，配置和测试数据链路链接（the data-link connection）的LCP协议（Link Control Protocol）。
	3. 建立和配置不同网络层协议的一组NCP协议（Network Control Protocol）。

2.2.1 ppp协议的封装
  我们知道ISO参考模型共分七层，自下而上分别是物理层、数据链路层、网络层、传输层、会话层、表示层和应用层。通常我们会依据协议所完成的功能将它与这七层进行对照，PPP协议就属于数据链路层协议。
普通的ppp帧数据报文格式
前面的几个字节都是固定的，是ppp链路帧报文的固定格式。就PPP协议本身而言，我们最关心的内容应该是它的协议域和信息域。
这里我们从下图2.3的普通数据报文抓包可以看出，在pppoe报文中，ppp数据帧则只有协议域+数据域。

协议域可用来区分PPP数据帧中信息域所承载的数据报文的内容。协议域的内容必须依据ISO 3309的地址扩展机制所给出的规定。该机制规定协议域所填充的内容必须为奇数，也即是要求低字节的最低位为"1"，高字节的最低位为"0"。如果当发送端发送的PPP数据帧的协议域字段不符合上述规定，则接收端会认为此数据帧是不可识别的，那么接收端会向发送端发送一个Protocol-Reject报文，在该报文尾部将完整地填充被拒绝的报文。协议域的具体取值如下表所示：

最典型的几种取值	0xc021	信息域中承载的是链路控制协议（LCP）的数据报文
	0xc023	信息域中承载的是PAP协议的认证报文
	0xc223	信息域中承载的是CHAP协议的认证报文
	0x8021	信息域中承载的是网络控制协议（NCP）的数据报文
	0x0021	信息域中承载的是IP数据报文

下面的几个ppp协议抓包展示了上面表格中的几个协议域。

	从上面的抓包报文，可以看出lcp报文的协议域为0xc021

	从上面的抓包报文，可以看出chap报文的协议域为0xc223.

	从上面的抓包报文，可以看出chap协议域为0x8021.
信息域缺省时最大长度不能超过1500字节, 1500字节大小等于PPP协议中配置参数选项MRU（Maximum Receive Unit）的缺省值，在实际应用当中可根据实际需要进行信息域最大封装长度选项的协商。
下面的两个抓包报文是协议域不识别的发送和应答报文。
 
首先服务器向AI路由器发送了一个IPV6CP报文控制配置请求。由于AI路由器不识别这个协议，就回应了一个Protocol-Reject报文。
 
2.2.2 LCP协议
  为了在一个很宽广的环境内能足够方便的使用，PPP提供了LCP。LCP用于就封装格式选项自动的达成一致，处理数据包大小的变化，探测looped-back链路和其他普通的配置错误，以及终止链路。提供的其他可选设备有：对链路中同等单元标识的认证，和当链路功能正常或链路失败时的决定。

2.2.3 ncp网络控制协议
	点对点连接可能和当前的一族网络协议产生许多问题。例如，基于电路交换的点对点连接（比如拨号模式服务），分配和管理IP地址，即使在LAN环境中，也非常困难。这些问题由一族网络控制协议（NCP）来处理，每一个协议管理着各自的网络层协议的特殊需求。

2.3 PPP链路的建立过程
   数据通信设备（在本文中指路由器）的两端如果希望通过PPP协议建立点对点的通信，无论哪一端的设备都需发送LCP数据报文来配置链路（测试链路）。一旦LCP的配置参数选项协商完后，通信的双方就会根据LCP配置请求报文中所协商的认证配置参数选项来决定链路两端设备所采用的认证方式。协议缺省情况下双方是不进行认证的，而直接进入到NCP配置参数选项的协商，直至所经历的几个配置过程全部完成后，点对点的双方就可以开始通过已建立好的链路进行网络层数据报文的传送了，整个链路就处于可用状态。只有当任何一端收到LCP或NCP的链路关闭报文时（一般而言协议是不要求NCP有关闭链路的能力的，因此通过情况下关闭链路的数据报文是在LCP协商阶段或应用程序会话阶段发出的）；物理层无法检测到载波或管理人员对该链路进行关闭操作，都会将该条链路断开，从而终止PPP会话。以下为PPP协议整个链路过程需经历阶段的状态转移图：
 
在点对点链路的配置、维护和终止过程中，PPP需经历以下几个阶段：
	*  链路不可用阶段，有时也称为物理层不可用阶段，PPP链路都需从这个阶段开始和结束。
   *  链路建立阶段，也是PPP协议最关键和最复杂的阶段。该阶段主要是发送一些配置报文来配置数据链路，这些配置的参数不包括网络层协议所需的参数。当完成数据报文的交换后，则会继续向下一个阶段跃迁，该下一个阶段既可是验证阶段，也可是网络层协议阶段，下一阶段的选择是依据链路两端的设备配置的（通常是由用户来配置，但对NAS或BAS设备的PPP模块缺省就需要支持PAP或CHAP中的一种认证方式）。
	*	验证阶段，多数情况下的链路两端设备是需要经过认证后才进入到网络层协议阶段，缺省情况下链路两端的设备是不进行认证的。在该阶段支持PAP和CHAP两种认证方式，验证方式的选择是依据在链路建立阶段双方进行协商的结果。
	*	网络层协议阶段，一旦PPP完成了前面几个阶段，每种网络层协议（IP、IPX和AppleTalk）会通过各自相应的网络控制协议进行配置，每个NCP协议可在任何时间打开和关闭。当一个NCP的状态机变成Opened状态时，则PPP就可以开始在链路上承载网络层的数据包报文了。
* 	网络终止阶段，PPP能在任何时候终止链路。当载波丢失、授权失败、链路质量检测失败和管理员人为关闭链路等情况均会导致链路终止。链路建立阶段可能通过交换LCP的链路终止报文来关闭链路，当链路关闭时，链路层会通知网络层做相应的操作，而且也会通过物理层强制关断链路。对于NCP协议，它是没有也没有必要去关闭PPP链路的。
2.4 LCP协议
2.4.1 LCP数据报文的封装方式
   LCP数据报文是在链路建立阶段被交换的，它作为PPP的净载荷被封装在PPP数据帧的信息域中，此时PPP数据帧的协议域固定填充0xC021，但在链路建立阶段的整个过程中信息域的内容是在变化的，它包括很多种类型的报文，所以这些报文也要通过相应的字段来区分。LCP数据报文的一般封装方式如下图所示：

代码域的长度为一个字节，主要是用来标识LCP数据报文的类型的。在链路建立阶段时，接收方收到LCP数据报文的代码域无法识别时，就会向对端发送一个LCP的代码拒绝报文（Code-Reject报文）。根据RFC的规定，到目前为止LCP共包括以下几种类型的数据报文：
代码值	报文类型	代码	报文类型
0x01	Config-Request	0x07	Code-Reject
0x02	Config-Ack	0x08	Protocol-Reject
0x03	Config-Nak	0x09	Echo-Request
0x04	Config-Reject	0x0A	Echo-Reply
0x05	Terminate-Request	0x0B	Discard-Request
0x06	Terminate-Ack	0x0C	Reserved

标识域也是一个字节，其目的是用来匹配请求和响应报文。一般而言在进入链路建立阶段时，通信双方无论哪一端都会连续发送几个配置请求报文（Config-Request报文），而这几个请求报文的数据域可能是完全一样的，而仅仅是它们的标志域不同罢了。通常一个配置请求报文的ID是从0x01开始逐步加1的，当对端接收到该配置请求报文后，无论使用何种报文（回应报文可能是Config-Ack、Config-Nak和Config-Reject三种报文中的一种）来回应对方，但必须要求回应报文中的ID要与接收报文中的ID一致，当通信设备收到回应后就可以将该回应与发送时的进行比较来决定下一步的操作。
以AI路由器的LCP过程进行说明。
 
   服务器向客户端AI路由器发送了一个 配置请求，这个配置请求报文包含了三个配置参数选项：MRU、认证协议和Magic Number。
   当客户端AI路由器正确接收到了该报文后，应该回应一个Config-Ack报文，如下图：
   该报文中唯一修改的内容就是代码域（02表示是Config-Ack报文），标识域与原报文中的一样。

2.4.2 LCP 数据报文的分类
  在前一小节我们可以看到，一共包括12种LCP数据报文，我们依据各报文的的功能又将其具体细化为以下三类：
链路配置报文，主要用来建立和配置一条链路的（Configure-Request，Configure-Ack，Configure-Nak，和Configure-Reject）。
链路终止报文，主要用来终止一条链路的（Terminate-Request 和 Terminate-Ack）。
链路维护报文，主要用来维护和调试链路的（Code-Reject, Protocol-Reject, Echo-Request, Echo-Reply, 和 Discard-Request）。

2.4.3 LCP的链路配置报文
 
上图为配置报文中配置选项的数据格式。
链路配置报文与其它两类报文有着明显的区别，它主要是用来协商链路的配置参数选项的，因此这种报文的数据域还要携带许多配置参数选项的
链路配置报文主要包括Config-Request、Config-Ack、Config-Nak和Config-Reject四种报文。
当通信双方需要建立链路时，无论哪一方都需要发送Config-Request报文并携带每一端自已所希望协商的配置参数选项，下表为一些可选的配置参数选项：
类型值	参数选项	类型值	参数选项
0x00	Reserved	0x05	Magic-Number
0x01	Maximum-Recieve-Unit	0x06	CBCP
0x02	Async-Control-Character-Map	0x07	Protocol-Field-Compress
0x03	Authentication-Protocol	0x08	Address-and-Control-Field-Compress
0x04	Quality-Protocol	0x0D	Multilink-Protocol

这个表格内的内容并非完全，可能还有一新定议的配置选项未列在其中，如有兴趣可参照相关的文档说明。
	当接收方收到Config-Request报文时，会在剩下的三种类型的报文中选择一种来响应对方的请求报文。
当接收Config-Request报文的一端能识别发送过来的所有配置参数选项且认可所有配置参数选项数据域的内容时，接收端将会给对端回一个Config-Ack报文并将配置请求报文中的配置参数选项原封不动的放置在Config-Ack报文的数据域内（根据协议的规定是不可改变配置参数选项的顺序）。当配置请求报文的发送端收到Config-Ack报后，则会从当前阶段进入到下一个阶段。
这里以AI路由器拨号时的LCP配置报文为例：
服务器给AI路由器发送一个配置报文。 

	AI路由器接受了服务器的MRU、认证协议和Magic Number，就回应了一个ACK报文。
 
这里唯一改变的就是代码域。
同样客户端AI路由器也可以向服务器发送配置请求。
 

服务器回应一个ack报文
 
表明服务器接收MRU和Magic Number的配置。

当接收Config-Request报文的一端能识别发送端所发送过来的所有配置参数选项，但对部分配置参数选项数据域中的内容不认可时，接收端将会给对端回应一个Config-Nak报文，该报文中只携带不认可的配置参数选项，而这些配置参数选项的数据内容为本端希望的值。然而当接收端收到Config-Nak报文后，会重新发送Config-Request报文，而这个Config-Request报文与上一次所发送的Config-Request报文区别在于那些被对端不认可的配置参数选项的内容被填写到刚刚协商完后再次发送的Config-Request报文中（Config-Nak报文发送回来的那些配置参数选项）。
当接收Config-Request报文的一端不能识别所有的发送端发送过来的配置参数选项时，此时接收端将会向对端回一个Config-Reject报文，该报文中的数据域只携带那些不能识别的配置参数选项（当配置参数选项的类型域不识别时）。当对端接收到Config-Reject报文后，同样会再次发送一个Config-Request报文，这个配置请求报文与上一次发送的区别在于将不可识别的那些配置参数选项给删除了。
所以我们能够看出，链路配置阶段也可能要经过几次协商后才能完成，但这与点对点两端的设备有着密切的联系。对于PPP的两个端点而言，两者是独立完成各自的配置参数选项的协商过程的。具体的配置参数选项待后续的章节中讲解。

2.4.4 LCP的链路终止报文
	链路终止报文分为Terminate-Request和Terminate-Reply两种报文。LCP报文中提供了一种机制来关闭一个点对点的连接，想要关断链路的一端会持续发送Terminate-Request报文，直到收到一个Terminate-Reply为止。接收端一旦收到了一个Terminate-Request报文后，必须回应一个Terminate-Reply报文，同时等待对端先将链路断开后，再完成本端的所有断开的操作。
LCP的链路终止报文的数据域与链路配置报文的数据域不一样，链路终止报文中无需携带各配置参数选项。对于链路终止报文也同样需要ID一致，当接收到Terminate-Reply报文才会做链路终止操作。
如下是链路终止的两个抓包报文：
 
路由器AI 发送了一个“Termination Request” 报文给服务器。
 
服务器回应了一个 “Termination Ack” 报文给路由器AI

2.4.5 LCP的链路维护报文
除上述两种报文类型以外，剩余的所有报文类型均归属链路维护报文。
当接收端发现LCP报文的代码域是一个不合法的值时，将会向发送端回应一个Code-Reject报文，在回应报文中会将所拒绝报文的内容附加上。
	当接收端发现所接收到的数据帧的协议域是一个不合法的值时，将会向发送端回应一个Protocol-Reject报文，发送端收到该拒绝报文后将停止发送该种协议类型的数据报文了。Protocol-Reject报文只能在LCP的状态机处于Opened状态时才可被处理，而在其它状态接收到该报文将被丢弃。在Protocol-Reject报文的数据域内将携带所拒绝报文的协议类型和报文内容。
	如下图所示：
 
	服务器向路由器AI发送了一个ppp IPv6控制报文配置请求，由于AI路由器不识别这种协议，就向服务器回应了一个Protocol-Reject报文，如下图所示：
 

Echo-Request报文和Echo-Reply报文主要用来检测双向链路上自环的问题，除此之外还可附带做一些链路质量的测试和其它功能。当LCP状态机处于Opened状态时，如果接收到了Echo-Request，就需向对端回送一个Echo-Reply报文。否则在其它LCP状态下，该类型的报文会被丢弃。这种类型数据报文的长度域后不是直接跟数据域，而是要插入4个字节的Magic-Number（魔术字），该魔术字是在LCP的Config-Request的配置参数选项协商时获得的。
	如下图所示：
 
	路由器AI向服务器发送了一个Echo Request 报文，接着服务器回应了一个Echo Reply报文，如下图所示：
	 

2.5 LCP的可选配置参数
LCP协议在对链路配置过程中需要进行一些可选配置参数选项的协商，我们在前面讲述的过程中已列举了许多配置参数选项，但我们只挑选其中较为重要的几个参数做相应的扩展说明（魔术字和认证协议选项）。关于一些更具体的细节和未涉及到的配置参数选项，请参数PPP的RFC文档（RFC1661）。

2.5.1 魔术字
魔术字是在LCP的Config-Request报文中被协商的，并且可被其它一些其它类型的LCP数据报文所使用，如前面已经说过的Echo-Request、Echo-Reply报文和Quality-Protocol报文等。对于PPP协议本身它是不要求协商魔术字的，如果在双方不协商魔术字的情况下，某些LCP的数据报文需要使用魔术字时，那么只能是将魔术字的内容填充为全0；反之，则填充为配置参数选项协商后的结果。
魔术字在目前所有的设备当中都是需要进行协商的，它被放在Config-Request的配置选项参数中进行发送，而且需要由自身的通信设备独立产生，协议为了避免双方可能产生同样的魔术字，从而导致通信出现不必要的麻烦，因此要求由设备采用一些随机方法产生一个独一无二的魔术字。一般来说魔术字的选择会采用设备的系列号、网络硬件地址或时钟。双方产生相同魔术字的可能性不能说是没有的，但应尽量避免，通常这种情况是发产在相同厂商的设备进行互连时，因为一个厂商所生产的设备产生魔术字的方法是一样的。
	魔术字产生的作用是用来帮助检测链路是否存在环路,当接收到一个带有Magic-Number配置选项的Configure-Request时候，接收到的Magic-Number与最后一个发送给peer的Configure-Request的Magic-Number相比较。如果两个Magic-Number不同，则该链路不被looped-back（因为魔术字是随机数）。
2.5.2 MRU（Maxium Receive Unit）
这个配置参数选项主要是Config-Request报文的发送端告诉接收端，本端接收到的PPP数据帧的数据域的最大值。通常情况下这个参数选项使用默认值（1500字节），因此在Config-Request报文中双方都不会携带这个配置参数选项。 当在某些特殊应用中，可能会使用到小于1500字节或大于1500字节的情况，这时在Config-Request报文就会携带要协商的MRU配置参数选项值。

2.5.3  认证协议
PPP协议也提供了可选的认证配置参数选项，缺省情况下点对点通信的两端是不进行认证的。在LCP的Config-Request报文中不可一次携带多种认证配置选项，必须二者择其一（PAP/CHAP），选择最希望的那一种，一般是在PPP设备互连的设备上进行配置的，但一般设备会默认支持一个缺省的认证方式（PAP是大部分设备所默认的认证方式）。当对端收到该配置请求报文后，如果支持配置参数选项中的认证方式，则回应一个Config-Ack报文；否则回应一个Config-Nak报文，并附带上自希望双方采用的认证方式。当对方接收到Config-Ack报文后就可以开始进行认证了，而如果收到得是Config-Nak报文，则根据自身是否支持Config-Nak报文中的认证方式来回应对方，如果支持则回应一个新的Config-Request（并携带上Config-Nak报文中所希望使用的认证协议），否则将回应一个Config-Reject报文，那么双方就无法通过认证，从而不可能建立起PPP链路。
	PPP支持两种授权协议：PAP（Password Authentication Protocol）和CHAP（Challenge Hand Authentication Protocol）
2.5.3.1 PAP认证
我们所知两个设备在使用PAP进行认证之前，应该确认那一方是验证方，那一方是被验证方。实际上对于使用PPP协议互连的两端来说，既可作为认证方，也可作为被认证方。但通常情况下，PAP只使用一个方向上的认证。一般在两端设备使用PAP协议之前，均会设备上进行一些相应的配置，对于宽带工程师而言MA5200可谓是大家最熟悉的产品了，它默认就作为验证方，但可通过使用命令PAP Authentication PAP/CHAP来更改认证方式，而对于被验证方而言只需设置用户名和密码即可。
PAP认证是两次握手，在链路建立阶段，依据设备上的配置情况，如果是使用PAP认证，则验证方在发送Config-Request报文时会携带认证配置参数选项，而对于被验证方而言则是不需要，它只需要收到该配置请求报文后根据自身的情况给对端返回相应的报文。如果点对点的两端设备采用的是PAP双向认证时，也即是它同时也作为验证方，则此时需要在配置请求报文中携带认证配置参数选项。因此，我们可以总结一下，如果对于点对点的两个设备在PPP链路建立的过程中使用的认证方式为PAP的话，那么验证方在其Config-Request报文中必须含有认证配置参数选项，且该认证配置参数选项的协议域为0xC023，下图为PAP认证的过程：
 
当通信设备的两端在收到对方返回的Config-Ack报文时，就从各自的链路建立阶段进入到认证阶段，那么作为被验证方此时需要向验证方发送PAP认证的请求报文，该请求报文携带了用户名和密码，当验证方收到该认证请求报文后，则会根据报文中的实际内容查找本地的数据库，如果该数据库中有与用户名和密码一致的选项时，则回向对方返回一个认证请求响应，告诉对方认证已通过。反之，如果用户名与密码不符，则向对方返回验证不通过的响应报文。如果双方都配置为验证方，则需要双方的两个单向验证过程都完成后，方可进入到网络层协议阶段，否则在一定次的认证失败后，则会从当前状态返回链路不可用状态。

2.5.3.2 CHAP 认证
	与PAP认证比起来，CHAP认证更具有安全性。采用PAP认证时，被验证是采用明文的方式直接将用户名和密码发送给验证方的，而对于CHAP认证则不一样。
CHAP为三次握手协议，它只在网络上传送用户名而不传送口令，因此安全性比PAP高。在验证一开始，不像PAP一样是由被验证方发送认证请求报文了，而是由验证方向被验证方发送一段随机的报文，并加上自己的主机名，我们通称这个过程叫做挑战。当被验证方收到验证方的验证请求，从中提取出验证方所发送过来的主机名，然后根据该主机名在被验证方设备的后台数据库中去查找相同的用户名的记录，当查找到后就使用该用户名所对应的密钥，然后根据这个密钥、报文ID和验证方发送的随机报文用Md5加密算法生成应答，随后将应答和自己的主机名送回，同样验证方收到被验证方发送回应后，提取被验证方的用户名，然后去查找本地的数据库，当找到与被验证方一致用户名后，根据该用户名所对应的密钥、保留报文ID和随机报文用Md5加密算法生成结果，和刚刚被验证方所返回的应答进行比较，相同则返回Ack，否则返回Nak，下图为CHAP的认证过程：
 
下面三个抓包是chap的三步握手认证过程：
 
   验证方向被验证方发送一个挑战。
  
被验证方应当。

 
验证方验证成功。

2.6 NCP协议
NCP协议的数据报文是在网络层协议阶段被交换的，在这个阶段所需的一些配置参数选项协商完后，就可以进行网络层的通信，也即是在点对点的链路上可以开始传送网络层的数据报文了。NCP协议主要包括IPCP、IPXCP等，但我们在实际当中最常遇见的也只有IPCP协议了，如果对IPXCP或其它的一些网络控制协议有兴趣，则可参见RFC1552。
2.6.1 IPCP
IPCP控制协议主要是负责完成IP网络层协议通信所需配置参数的选项协商的。IPCP在运行的过程当中，主要是完成点对点通信设备的两端动态的协商IP地址。我们依据两端设备的配置选项可将IPCP的协商过程分为"静态"和"动态"。何为静态，何为动态，这是一个相对的概念，也是自已总结出来的，可能不太准确，只作为参考使用。我们在下面会具体描述这两个过程。IPCP的数据报文同LCP的数据报文非常类似，只不过一个是在网络层协议阶段协商配置参数选项，而LCP协议则是在链路建立阶段协商配置参数选项的。除此之外是两者在所使用报文上的相似之处，我们知道LCP共包括十几种报文，而IPCP也包括多种报文，但它的报文类型只是LCP数据报文的一个子集（只有LCP代码域从1到7这七种报文），而且实际的数据报文交换过程中也仅涉及以下几种：Config-Request、Config-Ack、Config-Nak和Config-Reject（代码域从1到4，而链路终止报文一般而言是不在网络协议阶段使用的，而且也是不需要的）。以下就具体介绍一下IPCP控制协议的静态和动态的两个过程，实际上两者的区分是在于互连设备IP地址的获取过程。
	* 静态协商，也即是不协商。点对点的通信设备两端在PPP协商之前已配置好了IP地址，所以就无须在网络层协议阶段协商IP地址，而双方唯一要做的就是告诉对方自身的IP地址。在静态协商时，如果IPCP的Config-Request报文中只含有地址配置参数选项时（实际中可能还会附带其它配置参数选项，这些配置参数选项的协商与LCP阶段的一样，而我这里只提到了IP地址配置参数选项），无论是发送方还是接收方都同时发送Config-Request报文，其中配置选项中只含有各自的IP地址。当对端收到该报文后，会发送一个Config-Ack报文，这个目的是告诉对端我已经知道了你的IP地址，对路由器而言会增加一条到对端接口的主机路由。刚进入网络层协议阶段时，IPCP的状态机是initial的，但当完成了上述的整个过程后，IPCP的状态机改变为Opened，双方也就可以开始网络层数据网的传送了。
由于AI路由器采用的是动态协商，这里就不详细讨论。
*  动态协商，也即是一端配置为动态获取IP地址，另一端通过手动方式配置IP地址，且允许给对端分配IP地址，这个过程实际上可与窄带拨号上网的过程相一致，如果我们想用计算机或路由器上网，均会安装一个拨号适配器，而且拨号网络适配器是采用动态获取IP地址的方式。
这里以ＡＩ路由器拨号上网抓包为例，进行说明。 
	首先，服务器发送给客户端一个Configuration-request数据包。
 
  该报文含有服务器的ip地址信息。
 
	AI路由器给服务器回应了一个Configuration Ack报文，这就表示服务器的ip地址配置完成了。

 
	AI路由器向服务器发送一个Configuration request报文，说明了它的ip地址，IP压缩协议，dns服务器地址。
   由于服务器不能识别所有AI发送过来的配置参数选项，向AI路由器回了一个Config-Reject报文，如下：
	 
	该报文的数据域只携带那些不能识别的配置参数选项，这里的IP 压缩协议。
	当AI路由器接收到Config-Reject报文后，同样会再次发送一个Config-Request报文，这个配置请求报文与上一次发送的区别在于将不可识别的那些配置参数选项给删除了。如下所示：
 
由于AI路由器没有配置IP地址（而是动态获取IP地址），所以在IPCP的Config-Request报文的IP地址配置参数配置选项中的IP地址填充全0（也即是0.0.0.0），这样当服务器接收到这个Config-Request报文时，收到该配置请求报文后会迅检测IP地址的内容，如果发送为全0，则认为AI路由器的这个IP地址不是所希望的值，这样就回应一个Config-Nak报文，并将希望分配给对方的IP地址填充到Config-Nak报文内，如下图所示：
 
	这时当AI路由器收到Config-Nak报文后，就会重新发送一个Config-Request报文，这个报文中的IP地址配置选项为服务器在Nak报文中所提供的，如下图所示：
 
AI路由器收到服务器的Config-Ack报文，就表示路由器的IP地址配置完成。

